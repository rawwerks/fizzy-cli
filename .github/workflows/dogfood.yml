name: Nightly Dogfooding

on:
  schedule:
    # Run at 3 AM UTC every day (after the update workflow at 2 AM)
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  dogfood-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build

      - name: Run dogfooding tests
        id: dogfood
        env:
          FIZZY_TOKEN: ${{ secrets.FIZZY_TOKEN }}
          FIZZY_BASE_URL: ${{ secrets.FIZZY_BASE_URL }}
          FIZZY_ACCOUNT_SLUG: ${{ secrets.FIZZY_ACCOUNT_SLUG }}
        run: |
          set +e  # Don't exit on error
          ./scripts/dogfood-test.sh > dogfood-output.txt 2>&1
          TEST_EXIT_CODE=$?
          cat dogfood-output.txt
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          exit 0  # Don't fail the workflow yet

      - name: Check if dogfooding failed
        id: check-failure
        run: |
          if [ "${{ steps.dogfood.outputs.exit_code }}" != "0" ]; then
            echo "failed=true" >> $GITHUB_OUTPUT
            echo "Dogfooding tests failed with exit code ${{ steps.dogfood.outputs.exit_code }}"
          else
            echo "failed=false" >> $GITHUB_OUTPUT
            echo "Dogfooding tests passed!"
          fi

      - name: Create or update issue on failure
        if: steps.check-failure.outputs.failed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there's an existing open dogfooding issue
          EXISTING_ISSUE=$(gh issue list --label "dogfooding,automated" --state open --json number --jq '.[0].number')

          ISSUE_BODY="## üçï Dogfooding Test Failure - Action Required

          **Date:** $(date -u '+%Y-%m-%d at %H:%M UTC')
          **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          The nightly end-to-end dogfooding tests failed. These tests verify the CLI works correctly against a **real Fizzy instance** with actual API calls.

          ---

          ## Test Output

          \`\`\`
          $(cat dogfood-output.txt)
          \`\`\`

          ---

          ## Your Task (Claude Agent Instructions)

          You are a debugging agent tasked with fixing this dogfooding test failure. Follow these steps systematically:

          ### 1. Analyze the Failure

          - Read the test output above carefully
          - Identify which specific test(s) failed
          - Look for error messages, status codes, or authentication issues

          ### 2. Understand the Test

          The dogfood test (\`scripts/dogfood-test.sh\`) does the following:
          - Creates a temporary config directory with tokens.json
          - Runs these API operations against the real Fizzy instance:
            1. List boards
            2. List users
            3. List notifications
            4. Get current user info
            5. Check auth status

          ### 3. Debug Locally

          Run the test locally first:
          \`\`\`bash
          export FIZZY_TOKEN=\"<token_from_secrets>\"
          export FIZZY_BASE_URL=\"https://app.fizzy.do\"
          export FIZZY_ACCOUNT_SLUG=\"/6125212\"
          ./scripts/dogfood-test.sh
          \`\`\`

          ### 4. Common Failure Scenarios

          **Authentication Issues:**
          - Check if token format changed in tokens.json
          - Verify auth middleware is correctly reading HOME env var
          - Check if API authentication headers are correct

          **API Changes:**
          - Fizzy API endpoints may have changed
          - Check \`fizzy-api\` submodule for API changes
          - Update CLI code to match new API spec

          **Test Script Issues:**
          - Verify tokens.json format matches what CLI expects
          - Check if HOME directory override is working
          - Ensure FIZZY_BASE_URL env var is properly used

          ### 5. Fix the Issue

          - Make necessary changes to CLI code or test script
          - Run \`bun test\` to ensure unit tests still pass
          - Run \`./scripts/dogfood-test.sh\` locally to verify fix
          - Run \`./scripts/smoke-test.sh\` to ensure nothing broke

          ### 6. Commit and Verify

          \`\`\`bash
          git add <files>
          git commit -m \"Fix dogfooding test: <description>\"
          git push
          \`\`\`

          The workflow will run again on push and auto-close this issue if tests pass.

          ---

          ## Important Notes

          - **Do not skip steps** - systematic debugging is critical
          - **Test locally first** - don't rely solely on CI
          - **Check recent changes** - review recent commits to fizzy-api submodule
          - **Verify secrets** - ensure GitHub secrets are still valid

          ---

          ü§ñ This issue was automatically created by the dogfooding workflow.
          It will auto-close when tests pass."

          if [ -z "$EXISTING_ISSUE" ]; then
            # Create new issue
            gh issue create \
              --title "üçï Dogfooding tests failing" \
              --body "$ISSUE_BODY" \
              --label "dogfooding,automated,bug"
          else
            # Update existing issue
            gh issue comment "$EXISTING_ISSUE" --body "$ISSUE_BODY"
            echo "Updated existing issue #$EXISTING_ISSUE"
          fi

      - name: Close issue on success
        if: steps.check-failure.outputs.failed == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there's an open dogfooding issue
          EXISTING_ISSUE=$(gh issue list --label "dogfooding,automated" --state open --json number --jq '.[0].number')

          if [ -n "$EXISTING_ISSUE" ]; then
            gh issue close "$EXISTING_ISSUE" --comment "‚úÖ Dogfooding tests are now passing! Auto-closing this issue.

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            All tests passed successfully."
            echo "Closed issue #$EXISTING_ISSUE"
          fi

      - name: Fail workflow if tests failed
        if: steps.check-failure.outputs.failed == 'true'
        run: |
          echo "::error::Dogfooding tests failed. Issue created for tracking."
          exit 1
