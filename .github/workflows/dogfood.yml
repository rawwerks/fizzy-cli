name: Nightly Dogfooding

on:
  schedule:
    # Run at 3 AM UTC every day (after the update workflow at 2 AM)
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  dogfood-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build

      - name: Run dogfooding tests
        id: dogfood
        # REQUIRED SECRETS:
        # - FIZZY_TOKEN: Personal access token for Fizzy API
        # - FIZZY_BASE_URL: Base URL for Fizzy instance (default: https://app.fizzy.do)
        # - FIZZY_ACCOUNT_SLUG: Account slug (e.g., /6125212) - MUST be configured in GitHub Secrets
        env:
          FIZZY_TOKEN: ${{ secrets.FIZZY_TOKEN }}
          FIZZY_BASE_URL: ${{ secrets.FIZZY_BASE_URL }}
          FIZZY_ACCOUNT_SLUG: ${{ secrets.FIZZY_ACCOUNT_SLUG }}
        run: |
          set +e  # Don't exit on error
          ./scripts/dogfood-test.sh > dogfood-output.txt 2>&1
          TEST_EXIT_CODE=$?
          cat dogfood-output.txt
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          exit 0  # Don't fail the workflow yet

      - name: Check if dogfooding failed
        id: check-failure
        run: |
          if [ "${{ steps.dogfood.outputs.exit_code }}" != "0" ]; then
            echo "failed=true" >> $GITHUB_OUTPUT
            echo "Dogfooding tests failed with exit code ${{ steps.dogfood.outputs.exit_code }}"
          else
            echo "failed=false" >> $GITHUB_OUTPUT
            echo "Dogfooding tests passed!"
          fi

      - name: Parse test output and create detailed report
        if: steps.check-failure.outputs.failed == 'true'
        id: parse-output
        run: |
          # Extract test statistics from output
          PASSED=$(grep "‚úÖ Passed:" dogfood-output.txt | sed 's/.*: //' || echo "0")
          FAILED=$(grep "‚ùå Failed:" dogfood-output.txt | sed 's/.*: //' || echo "0")
          SKIPPED=$(grep "‚è≠Ô∏è  Skipped:" dogfood-output.txt | sed 's/.*: //' || echo "0")
          MISSING=$(grep "‚ö†Ô∏è  Missing Features:" dogfood-output.txt | sed 's/.*: //' || echo "0")
          COVERAGE=$(grep "Coverage:" dogfood-output.txt | sed 's/.*: //' | tr -d '%' || echo "0")

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "missing=$MISSING" >> $GITHUB_OUTPUT
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

          # Extract failed test names
          FAILED_TESTS=$(grep "Error:" dogfood-output.txt | sed 's/.*Error: //' || echo "")
          echo "failed_tests<<EOF" >> $GITHUB_OUTPUT
          echo "$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or update issue on failure
        if: steps.check-failure.outputs.failed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PASSED: ${{ steps.parse-output.outputs.passed }}
          FAILED: ${{ steps.parse-output.outputs.failed }}
          MISSING: ${{ steps.parse-output.outputs.missing }}
          COVERAGE: ${{ steps.parse-output.outputs.coverage }}
        run: |
          # Check if there's an existing open dogfooding issue
          EXISTING_ISSUE=$(gh issue list --label "dogfooding,automated" --state open --json number --jq '.[0].number')

          ISSUE_BODY="## üçï Comprehensive Dogfooding Test Failure

          **Date:** $(date -u '+%Y-%m-%d at %H:%M UTC')
          **Workflow:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          **API Coverage:** ${COVERAGE}% (Target: 100%)

          ### Test Results Summary

          | Status | Count |
          |--------|-------|
          | ‚úÖ Passed | $PASSED |
          | ‚ùå Failed | $FAILED |
          | ‚è≠Ô∏è Skipped | ${{ steps.parse-output.outputs.skipped }} |
          | ‚ö†Ô∏è Missing | $MISSING |

          ---

          ## Test Output

          <details>
          <summary>Click to expand full test output</summary>

          \`\`\`
          $(cat dogfood-output.txt)
          \`\`\`

          </details>

          ---

          ## ü§ñ Claude Agent: Fix This Issue

          You are a self-healing agent. This test suite validates **ALL 49 Fizzy API endpoints**. Your job is to ensure we never have untested or broken features again.

          ### Step 1: Understand What Failed

          The comprehensive dogfooding test (\`scripts/dogfood-test.sh\`) tests:
          - ‚úÖ **${PASSED} working endpoints** - These are implemented and passing
          - ‚ùå **${FAILED} broken endpoints** - These are implemented but FAILING (fix these!)
          - ‚ö†Ô∏è **${MISSING} missing endpoints** - These are not implemented yet (check beads for in-progress work)

          **CRITICAL:** Distinguish between:
          1. **Broken features** (‚ùå) - Implemented code that's failing ‚Üí FIX IMMEDIATELY
          2. **Missing features** (‚ö†Ô∏è) - Not implemented yet ‚Üí Check beads issues for ongoing work

          ### Step 2: Identify Root Cause

          **If tests are failing (‚ùå):**
          - Schema validation errors ‚Üí Check \`src/schemas/api.ts\` matches actual API responses
          - Authentication errors ‚Üí Check token storage in \`src/lib/auth/token-storage.ts\`
          - API changes ‚Üí Check \`fizzy-api\` submodule for recent changes
          - Network/timeout errors ‚Üí Check error handling in \`src/lib/api/client.ts\`

          **If missing features are reported (‚ö†Ô∏è):**
          - Check \`bd list --status=in_progress\` - Are subagents already implementing these?
          - Check \`bd list --status=open\` - Are these tracked as issues?
          - Review \`PRODUCTION_AUDIT.md\` for priority breakdown

          ### Step 3: Investigate Locally

          \`\`\`bash
          # Clone and setup
          git pull origin master

          # Run comprehensive tests
          ./scripts/dogfood-test.sh  # Requires FIZZY_TOKEN env var

          # Check what's being worked on
          bd list --status=in_progress
          bd list --status=open --priority=0  # P0 critical issues

          # Run unit tests
          bun test

          # Check for type errors
          bun run typecheck
          \`\`\`

          ### Step 4: Fix Broken Features (Priority 1)

          If **${FAILED} tests are failing**:
          1. Read the error messages in the test output above
          2. Identify which command/endpoint is failing
          3. Check \`src/commands/<resource>.ts\` for that command
          4. Check \`src/schemas/api.ts\` for schema validation
          5. Test locally: \`bun dist/index.js <failing-command> --json\`
          6. Fix the issue (schema, API client, command logic)
          7. Run \`bun test\` to ensure tests pass
          8. Run \`./scripts/dogfood-test.sh\` to verify the fix
          9. Commit and push

          ### Step 5: Verify Implementation Progress

          If **${MISSING} features are missing**:
          1. Run \`bd list --status=in_progress\` - check if subagents are working on these
          2. Run \`bd stats\` - check overall project health
          3. **DO NOT implement new features unless specifically asked** - focus on fixing broken ones first
          4. If subagents are stuck, check their task output and help them debug

          ### Step 6: Validate Against Fizzy API

          The comprehensive test validates ALL endpoints from \`fizzy-api/docs/API.md\`:
          - Identity (1 endpoint)
          - Boards (5 endpoints)
          - Cards (12 endpoints)
          - Comments (5 endpoints)
          - Reactions (3 endpoints)
          - Steps (4 endpoints)
          - Tags (1 endpoint)
          - Columns (5 endpoints)
          - Users (4 endpoints)
          - Notifications (4 endpoints)
          - File uploads (2 operations)

          **Total: 49 API endpoints**

          ### Step 7: Update Beads

          After fixing issues:
          \`\`\`bash
          # Close fixed issues
          bd close <issue-id> --reason=\"Fixed in commit <sha>\"

          # Sync with git
          bd sync
          git push
          \`\`\`

          ### Step 8: Commit Your Fixes

          \`\`\`bash
          git add <changed-files>
          git commit -m \"Fix dogfooding failures: <description>

          - Fixed <specific-issue-1>
          - Fixed <specific-issue-2>

          Resolves <beads-issue-id>\"

          bd sync  # Sync beads changes
          git push
          \`\`\`

          ---

          ## Important Self-Healing Principles

          1. **Fix broken features first** - Missing features are tracked in beads, broken features need immediate attention
          2. **Test locally before pushing** - Don't rely solely on CI to validate fixes
          3. **Update schemas when API changes** - The Fizzy API evolves, schemas must stay in sync
          4. **Check beads for in-progress work** - Don't duplicate effort if subagents are already working
          5. **Use comprehensive tests** - This suite catches issues that unit tests miss

          ---

          ü§ñ **Auto-generated by:** Comprehensive Dogfooding Workflow
          üìä **Current Coverage:** ${COVERAGE}% | **Target:** 100%
          ‚úÖ **Auto-closes when:** All tests pass"

          if [ -z "$EXISTING_ISSUE" ]; then
            # Create new issue
            gh issue create \
              --title "üçï Dogfooding: $FAILED failures, $MISSING missing features (${COVERAGE}% coverage)" \
              --body "$ISSUE_BODY" \
              --label "dogfooding,automated,bug"
          else
            # Update existing issue with new run
            gh issue comment "$EXISTING_ISSUE" --body "## üîÑ New Test Run: $(date -u '+%Y-%m-%d at %H:%M UTC')

            **Status:** ‚ùå Still failing
            **Coverage:** ${COVERAGE}%
            **Failed:** $FAILED | **Missing:** $MISSING | **Passed:** $PASSED

            See full details above for updated test output and instructions."
            echo "Updated existing issue #$EXISTING_ISSUE"
          fi

      # ============================================
      # SELF-HEALING: Claude Code auto-fixes failures
      # ============================================

      - name: Read dogfood output for Claude
        if: steps.check-failure.outputs.failed == 'true'
        id: read-output
        run: |
          # Store output in env var (escape for GitHub Actions)
          OUTPUT=$(cat dogfood-output.txt)
          echo "dogfood_output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude Code self-healing
        if: steps.check-failure.outputs.failed == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            The dogfooding tests failed. Here is the output:

            ${{ steps.read-output.outputs.dogfood_output }}

            Fix the failing tests. The codebase is fizzy-cli, a CLI for the Fizzy API.

            Steps:
            1. Analyze the failures above
            2. Fix the root causes (schemas in src/schemas/api.ts, API client in src/lib/api/, commands in src/commands/)
            3. Run 'bun test' to verify fixes work
            4. Run 'bun run typecheck' to ensure no type errors

            Do NOT create new features - only fix broken tests.
            Do NOT modify the workflow files.
            Focus on fixing schema mismatches, API response handling, and command logic.
          allowed_tools: "Edit,Read,Glob,Grep,Bash,Write"
          direct_prompt: true
          timeout_minutes: 30
        env:
          FIZZY_TOKEN: ${{ secrets.FIZZY_TOKEN }}
          FIZZY_BASE_URL: ${{ secrets.FIZZY_BASE_URL }}
          FIZZY_ACCOUNT_SLUG: ${{ secrets.FIZZY_ACCOUNT_SLUG }}

      # ============================================
      # END SELF-HEALING
      # ============================================

      - name: Close issue on success
        if: steps.check-failure.outputs.failed == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there's an open dogfooding issue
          EXISTING_ISSUE=$(gh issue list --label "dogfooding,automated" --state open --json number --jq '.[0].number')

          if [ -n "$EXISTING_ISSUE" ]; then
            gh issue close "$EXISTING_ISSUE" --comment "‚úÖ Dogfooding tests are now passing! Auto-closing this issue.

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            All tests passed successfully."
            echo "Closed issue #$EXISTING_ISSUE"
          fi

      - name: Fail workflow if tests failed
        if: steps.check-failure.outputs.failed == 'true'
        run: |
          echo "::error::Dogfooding tests failed. Issue created for tracking."
          exit 1
