name: Nightly Dogfooding

on:
  schedule:
    # Run at 3 AM UTC every day (after the update workflow at 2 AM)
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  dogfood-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build

      - name: Run dogfooding tests
        id: dogfood
        env:
          FIZZY_TOKEN: ${{ secrets.FIZZY_TOKEN }}
          FIZZY_BASE_URL: ${{ secrets.FIZZY_BASE_URL }}
          FIZZY_ACCOUNT_SLUG: ${{ secrets.FIZZY_ACCOUNT_SLUG }}
        run: |
          set +e  # Don't exit on error
          ./scripts/dogfood-test.sh > dogfood-output.txt 2>&1
          TEST_EXIT_CODE=$?
          cat dogfood-output.txt
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          exit 0  # Don't fail the workflow yet

      - name: Check if dogfooding failed
        id: check-failure
        run: |
          if [ "${{ steps.dogfood.outputs.exit_code }}" != "0" ]; then
            echo "failed=true" >> $GITHUB_OUTPUT
            echo "Dogfooding tests failed with exit code ${{ steps.dogfood.outputs.exit_code }}"
          else
            echo "failed=false" >> $GITHUB_OUTPUT
            echo "Dogfooding tests passed!"
          fi

      - name: Create or update issue on failure
        if: steps.check-failure.outputs.failed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there's an existing open dogfooding issue
          EXISTING_ISSUE=$(gh issue list --label "dogfooding,automated" --state open --json number --jq '.[0].number')

          ISSUE_BODY="## Dogfooding Test Failure

          The nightly dogfooding tests failed on $(date -u '+%Y-%m-%d at %H:%M UTC').

          **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### Test Output
          \`\`\`
          $(cat dogfood-output.txt | tail -50)
          \`\`\`

          ### Next Steps
          1. Review the test failures above
          2. Fix the CLI or test script as needed
          3. Run \`./scripts/dogfood-test.sh\` locally to verify
          4. Commit the fix and the workflow will re-test automatically

          ---
          ü§ñ This issue was automatically created by the dogfooding workflow.
          It will auto-close when tests pass."

          if [ -z "$EXISTING_ISSUE" ]; then
            # Create new issue
            gh issue create \
              --title "üçï Dogfooding tests failing" \
              --body "$ISSUE_BODY" \
              --label "dogfooding,automated,bug"
          else
            # Update existing issue
            gh issue comment "$EXISTING_ISSUE" --body "$ISSUE_BODY"
            echo "Updated existing issue #$EXISTING_ISSUE"
          fi

      - name: Close issue on success
        if: steps.check-failure.outputs.failed == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there's an open dogfooding issue
          EXISTING_ISSUE=$(gh issue list --label "dogfooding,automated" --state open --json number --jq '.[0].number')

          if [ -n "$EXISTING_ISSUE" ]; then
            gh issue close "$EXISTING_ISSUE" --comment "‚úÖ Dogfooding tests are now passing! Auto-closing this issue.

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            All tests passed successfully."
            echo "Closed issue #$EXISTING_ISSUE"
          fi

      - name: Fail workflow if tests failed
        if: steps.check-failure.outputs.failed == 'true'
        run: |
          echo "::error::Dogfooding tests failed. Issue created for tracking."
          exit 1
